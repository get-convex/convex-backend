---
title: "本番環境へのアプリのデプロイ"
hide_table_of_contents: true
pagination_prev: search
description: "安全で信頼性の高い本番アプリを構築するためのヒント"
---

Convex は、本番環境での実運用トラフィックを処理できるように設計されています。ここでは、
アプリの本番環境へのデプロイと運用について説明します。

## プロジェクト管理 \{#project-management\}

Convex にサインアップすると、あなた用の Convex チームが作成されます。
[ダッシュボードからチームを作成](/dashboard/teams.md)し、他のメンバーを
そのチームに追加できます。チームは
[Starter](https://www.convex.dev/pricing) プランにアップグレードして従量課金で利用するか、
[Professional](https://www.convex.dev/pricing) プランにアップグレードして、追加機能やより高い組み込み制限、
24 時間サポート、割引された従量課金料金を利用できます。

各チームは複数のプロジェクトを持つことができます。`npx convex dev` を初めて実行したとき、
プロジェクトが自動的に作成されます。プロジェクトはダッシュボードから作成することもできます。

すべてのプロジェクトには共有の本番デプロイメントが 1 つと、チームメンバーごとに 1 つの開発
デプロイメントがあります。これにより、各チームメンバーは本番デプロイメントにデプロイする前に、
変更を個別に加えてテストできます。

通常、1 つのプロジェクトに属するすべてのデプロイメントは同じコードベース（またはそのバージョン）
を実行しますが、Convex がそれを強制することはありません。同じコードベースを、異なるプロジェクトに
属する複数の別々の本番デプロイメント上で実行することもできます。詳細は、下記の
[ステージング](#staging-environment) を参照してください。

## 本番環境へのデプロイ \{#deploying-to-production\}

Convex の各デプロイメントではバックエンドロジックが実行され、多くの場合、そのバックエンドを利用するクライアントも開発します。クライアントが Web アプリの場合は、クライアントと Convex バックエンドをまとめてデプロイする方法について、[ホスティングとデプロイメント](/production/hosting/hosting.mdx) ガイドを参照してください。

バックエンド単体をデプロイすることもできます。詳しくは [プロジェクト設定](/production/project-configuration.mdx) ページを参照してください。

## ステージング環境 \{#staging-environment\}

Convex の[プレビューデプロイメント](/production/hosting/preview-deployments.mdx)を使うと、
本番環境にデプロイする前にチームで変更をテストできます。より恒久的な
ステージング環境が必要な場合は、ステージング用に別の Convex プロジェクトを用意し、
[`npx convex deploy`](/cli.md#deploy-convex-functions-to-production) を実行するときに
`CONVEX_DEPLOY_KEY` 環境変数を設定して、そのプロジェクトにデプロイできます。

## 一般的なチーム開発ワークフロー \{#typical-team-development-workflow\}

Convex を使って開発するチームは、通常次のようなワークフローに従います。

1. チームの最初のプロジェクトであれば、まずチームメンバーの一人が
   ダッシュボード上でチームを作成します。
2. チームメンバーの一人が `npx convex dev` を実行してプロジェクトを作成します。
   このとき、[クイックスタート](/quickstarts.mdx) や
   [テンプレート](https://www.convex.dev/templates) から始めることもあります。
3. そのメンバーが初期コードから Git リポジトリを作成し、
   チームメンバーと共有します（GitHub や GitLab など経由）。
4. 他のチームメンバーはコードベースを取得し、`npx convex dev` を実行して
   自分用の dev デプロイメントを作成します。
5. すべてのチームメンバーがバックエンドの変更を行い、
   各自の dev デプロイメント上でテストできます。変更の準備ができたら、
   そのメンバーはプルリクエストを作成（または共有ブランチにコミット）します。
   * [Backup / Restore](/database/backup-restore) を使って、
     本番デプロイメントのデータを dev デプロイメントに投入できます。
   * [Data import](/database/import-export/import.mdx) を使って、
     dev デプロイメントにテスト用のシードデータを投入できます。
   * [Pro plan](https://www.convex.dev/pricing) のチームメンバーは、
     個別の
     [preview deployments](/production/hosting/preview-deployments.mdx) を利用して、
     互いのプルリクエストをテストできます。
6. 本番へのデプロイは、指定されたブランチ（例えば `main`）に変更が
   マージされたときに
   [自動的に](/production/hosting/hosting.mdx) 行われるように設定できます。
   * あるいは、チームメンバーの一人が `npx convex deploy` を実行して、
     手動で本番にデプロイすることもできます。

### 安全な変更の行い方 \{#making-safe-changes\}

特にアプリが本番稼働している場合、Convex のコードベースに加える変更によってアプリが壊れないようにする必要があります。

安全でない変更のうち一部は Convex 側で検出・処理されますが、それ以外は自分で対処する必要があります。

1. **スキーマは常に既存データと一致していなければなりません。** Convex はこの制約を強制します。
   既存データと一致しないスキーマを、そのデータを含むデプロイメントに対してプッシュすることはできません（スキーマの強制を無効化しない限り）。一般に、次のことは安全です。
   1. スキーマに新しいテーブルを追加する。
   2. 既存テーブルのスキーマに `optional` フィールドを追加し、そのテーブル内のすべてのドキュメントでそのフィールドを設定してから、そのフィールドを必須にする。
   3. 既存のフィールドを `optional` としてマークし、そのフィールドをすべてのドキュメントから削除してから、そのフィールド自体を削除する。
   4. 既存フィールドを、既存の型と新しい型との `union` としてマークし、テーブル内のすべてのドキュメントでそのフィールドを新しい型に合わせて更新してから、型を新しい型のみに変更する。
2. **関数は後方互換であるべきです。** クライアントがウェブサイトだけであり、バックエンドと同時にデプロイしている場合であっても、バックエンドが変更された後も、ユーザーは古いバージョンのウェブサイトを使い続けている可能性があります。
   そのため、古いクライアントを壊してもよいと判断できるようになるまでは、関数は後方互換にしておくべきです。一般に、次のことは安全です。
   1. 新しい関数を追加する。
   2. 既存の関数に `optional` な名前付き引数を追加する。
   3. 既存の名前付き引数を `optional` としてマークする。
   4. 既存の名前付き引数を、既存の型と新しい型との `union` としてマークする。
   5. 古いクライアントから渡される引数に対して、その振る舞いが依然として古いクライアントにとって許容できるものになるような形で、関数の挙動を変更する。
3. **スケジュールされた関数も後方互換であるべきです。** 将来実行する関数をスケジュールする際には、その実行時に渡される引数の値を指定します。関数が実行されるときには、常に現在デプロイされているバージョンが実行されます。スケジュールした時点と実行される時点の間に関数を変更した場合は、新しいバージョンが古い引数に対しても妥当な挙動をすることを保証する必要があります。

<StackPosts query="deploy" />